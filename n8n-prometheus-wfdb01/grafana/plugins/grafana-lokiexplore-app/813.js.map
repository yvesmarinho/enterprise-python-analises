{"version":3,"file":"813.js?_cache=a0647ebfec1def251fa4","mappings":"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","sources":["webpack://grafana-lokiexplore-app/./Components/AppConfig/AppConfig.tsx","webpack://grafana-lokiexplore-app/./featureFlags/tracking.ts","webpack://grafana-lokiexplore-app/./featureFlags/openFeature.ts","webpack://grafana-lokiexplore-app/./services/utils.ts"],"sourcesContent":["import React, { ChangeEvent, useState } from 'react';\n\nimport { css } from '@emotion/css';\nimport { isNumber } from 'lodash';\nimport { lastValueFrom } from 'rxjs';\n\nimport {\n  AppPluginMeta,\n  DataSourceInstanceSettings,\n  GrafanaTheme2,\n  PluginConfigPageProps,\n  PluginMeta,\n  rangeUtil,\n} from '@grafana/data';\nimport { DataSourcePicker, getBackendSrv, locationService } from '@grafana/runtime';\nimport { Button, Checkbox, Field, FieldSet, Input, useStyles2 } from '@grafana/ui';\n\nimport { logger } from '../../services/logger';\nimport { getDefaultDatasourceFromDatasourceSrv, getLastUsedDataSourceFromStorage } from '../../services/store';\n\nexport type JsonData = {\n  dataSource?: string;\n  interval?: string;\n  patternsDisabled?: boolean;\n};\n\ntype State = {\n  dataSource: string;\n  interval: string;\n  isValid: boolean;\n  patternsDisabled: boolean;\n};\n\n// 1 hour minimum\nconst MIN_INTERVAL_SECONDS = 3600;\n\ninterface Props extends PluginConfigPageProps<AppPluginMeta<JsonData>> {}\n\nconst AppConfig = ({ plugin }: Props) => {\n  const styles = useStyles2(getStyles);\n  const { enabled, jsonData, pinned } = plugin.meta;\n\n  const [state, setState] = useState<State>({\n    dataSource:\n      jsonData?.dataSource ?? getDefaultDatasourceFromDatasourceSrv() ?? getLastUsedDataSourceFromStorage() ?? '',\n    interval: jsonData?.interval ?? '',\n    isValid: isValid(jsonData?.interval ?? ''),\n    patternsDisabled: jsonData?.patternsDisabled ?? false,\n  });\n\n  const onChangeDatasource = (ds: DataSourceInstanceSettings) => {\n    setState({\n      ...state,\n      dataSource: ds.uid,\n    });\n  };\n\n  const onChangeInterval = (event: ChangeEvent<HTMLInputElement>) => {\n    const interval = event.target.value.trim();\n    setState({\n      ...state,\n      interval,\n      isValid: isValid(interval),\n    });\n  };\n\n  const onChangePatternsDisabled = (event: ChangeEvent<HTMLInputElement>) => {\n    const patternsDisabled = event.currentTarget.checked;\n    setState({\n      ...state,\n      patternsDisabled,\n    });\n  };\n\n  return (\n    <div data-testid={testIds.appConfig.container}>\n      <FieldSet label=\"Settings\">\n        <Field\n          description={\n            <span>\n              The default data source to be used for new Logs Drilldown users. Each user can override their default by\n              setting another data source in Logs Drilldown.\n            </span>\n          }\n          label={'Default data source'}\n        >\n          <DataSourcePicker\n            width={60}\n            filter={(ds) => ds.type === 'loki'}\n            current={state.dataSource}\n            onChange={onChangeDatasource}\n          />\n        </Field>\n\n        <Field\n          invalid={!isValid(state.interval)}\n          error={'Interval is invalid. Please enter an interval longer then \"60m\". For example: 3d, 1w, 1m'}\n          description={\n            <span>\n              The maximum interval that can be selected in the time picker within the Grafana Logs Drilldown app. If\n              empty, users can select any time range interval in Grafana Logs Drilldown. <br />\n              Example values: 7d, 24h, 2w\n            </span>\n          }\n          label={'Maximum time picker interval'}\n          className={styles.marginTop}\n        >\n          <Input\n            width={60}\n            id=\"interval\"\n            data-testid={testIds.appConfig.interval}\n            label={`Max interval`}\n            value={state?.interval}\n            placeholder={`7d`}\n            onChange={onChangeInterval}\n          />\n        </Field>\n\n        <Field\n          className={styles.marginTop}\n          description={\n            <span>\n              Disables Logs Drilldown&apos;s usage of the{' '}\n              <a\n                className=\"external-link\"\n                href=\"https://grafana.com/docs/loki/latest/reference/loki-http-api/#patterns-detection\"\n                target=\"_blank\"\n                rel=\"noreferrer\"\n              >\n                Loki Patterns API\n              </a>{' '}\n              endpoint, and removes the Patterns tab.\n            </span>\n          }\n          label={'Disable Loki patterns'}\n        >\n          <Checkbox\n            id=\"disable-patterns\"\n            data-testid={testIds.appConfig.interval}\n            label={`Disable patterns`}\n            value={state?.patternsDisabled}\n            placeholder={`7d`}\n            onChange={onChangePatternsDisabled}\n          />\n        </Field>\n\n        <div className={styles.marginTop}>\n          <Button\n            type=\"submit\"\n            data-testid={testIds.appConfig.submit}\n            onClick={() =>\n              updatePluginAndReload(plugin.meta.id, {\n                enabled,\n                jsonData: {\n                  dataSource: state.dataSource,\n                  interval: state.interval,\n                  patternsDisabled: state.patternsDisabled,\n                },\n                pinned,\n              })\n            }\n            disabled={!isValid(state.interval)}\n          >\n            Save settings\n          </Button>\n        </div>\n        <p className={styles.note}>Active users must refresh the app to update configuration.</p>\n      </FieldSet>\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  colorWeak: css`\n    color: ${theme.colors.text.secondary};\n  `,\n  icon: css({\n    marginLeft: theme.spacing(1),\n  }),\n  label: css({\n    alignItems: 'center',\n    display: 'flex',\n    marginBottom: theme.spacing(0.75),\n  }),\n  marginTop: css`\n    margin-top: ${theme.spacing(3)};\n  `,\n  marginTopXl: css`\n    margin-top: ${theme.spacing(6)};\n  `,\n  note: css({\n    color: theme.colors.text.secondary,\n    marginBottom: theme.spacing(1),\n    marginTop: theme.spacing(1),\n  }),\n});\n\nconst updatePluginAndReload = async (pluginId: string, data: Partial<PluginMeta<JsonData>>) => {\n  try {\n    await updatePlugin(pluginId, data);\n\n    // Reloading the page as the changes made here wouldn't be propagated to the actual plugin otherwise.\n    // This is not ideal, however unfortunately currently there is no supported way for updating the plugin state.\n    locationService.reload();\n  } catch (e) {\n    logger.error(e, { msg: 'Error while updating the plugin' });\n  }\n};\n\nconst testIds = {\n  appConfig: {\n    container: 'data-testid ac-container',\n    datasource: 'data-testid ac-datasource-input',\n    interval: 'data-testid ac-interval-input',\n    pattern: 'data-testid ac-patterns-disabled',\n    submit: 'data-testid ac-submit-form',\n  },\n};\n\nexport const updatePlugin = async (pluginId: string, data: Partial<PluginMeta>) => {\n  const response = getBackendSrv().fetch({\n    data,\n    method: 'POST',\n    url: `/api/plugins/${pluginId}/settings`,\n  });\n\n  const dataResponse = await lastValueFrom(response);\n\n  return dataResponse.data;\n};\n\nconst isValid = (interval: string): boolean => {\n  try {\n    if (interval) {\n      const seconds = rangeUtil.intervalToSeconds(interval);\n      return isNumber(seconds) && seconds >= MIN_INTERVAL_SECONDS;\n    } else {\n      // Empty strings are fine\n      return true;\n    }\n  } catch (e) {}\n\n  return false;\n};\n\nexport default AppConfig;\n","import type { EvaluationDetails, FlagValue, Hook, HookContext } from '@openfeature/web-sdk';\n\nimport { config } from '@grafana/runtime';\n\nimport { featureFlagTrackingKeys, type FlagTrackingKey } from './openFeature';\n\nexport const TRACKED_FLAG_VALUES: Record<FlagTrackingKey, unknown> = {\n  experiment_fake_flag: null,\n};\n\n/**\n * A hook that tracks feature flag evaluations and stores the flag value in module scope.\n * This is used to report the flag value in analytics interactions.\n */\nexport class TrackingHook implements Hook {\n  constructor() {}\n\n  after(hookContext: HookContext, evaluationDetails: EvaluationDetails<FlagValue>): void {\n    if (!featureFlagTrackingKeys[hookContext.flagKey]) {\n      return;\n    }\n\n    // For tracking, all we need to do is store the flag value in module scope.\n    // We'll use this value later when reporting corresponding interactions.\n    TRACKED_FLAG_VALUES[featureFlagTrackingKeys[hookContext.flagKey]] = evaluationDetails.value;\n  }\n}\n\n/**\n * Returns the analytics payload for a tracked feature flag, optionally including the open feature context.\n *\n * @param flagTrackingKey - The `trackingKey` of the feature flag to track, as defined in the `goffFeatureFlags` object.\n * @param addOpenFeatureContext - Whether to include the open feature context in the payload.\n * @returns The analytics payload for the tracked flag, as a record with the flag tracking key as the key and the flag value as the value.\n */\nexport function getTrackedFlagPayload(\n  flagTrackingKey: FlagTrackingKey,\n  addOpenFeatureContext = false\n): Partial<Record<FlagTrackingKey, unknown>> | null {\n  const trackedFlagItem = TRACKED_FLAG_VALUES[flagTrackingKey];\n\n  if (!trackedFlagItem) {\n    return null;\n  }\n\n  return {\n    [flagTrackingKey]: trackedFlagItem,\n    ...(addOpenFeatureContext ? config.openFeatureContext : {}),\n  };\n}\n","import { OFREPWebProvider } from '@openfeature/ofrep-web-provider';\nimport { ClientProviderStatus, OpenFeature, ProviderEvents, type Client, type JsonValue } from '@openfeature/web-sdk';\n\nimport { config } from '@grafana/runtime';\n\nimport { TrackingHook } from './tracking';\nimport { logger } from 'services/logger';\nimport { getObjectKeys } from 'services/utils';\n\n/**\n * Maps valueType strings to their corresponding TypeScript types.\n */\ntype ValueTypeMap = {\n  boolean: boolean;\n  number: number;\n  object: JsonValue;\n  string: string;\n};\n\n/**\n * Core feature flag definition matching the OpenFeature OFREP response format.\n * Used for flags that come from Grafana core.\n *\n * @example\n * ```ts\n * const flag: CoreFeatureFlag<'boolean'> = {\n *   valueType: 'boolean',\n *   value: true,\n *   reason: 'static provider evaluation result',\n *   variant: 'default',\n * };\n * ```\n */\ntype CoreFeatureFlag<VT extends keyof ValueTypeMap> = {\n  reason: string;\n  value: ValueTypeMap[VT];\n  valueType: VT;\n  variant: string;\n};\n\n/**\n * Experiment feature flag definition for logs-drilldown scoped flags.\n * Used for A/B testing and feature experiments.\n *\n * @example\n * ```ts\n * const flag: ExperimentFeatureFlag<'string', readonly ['treatment', 'control']> = {\n *   valueType: 'string',\n *   values: ['treatment', 'control'],\n *   defaultValue: 'control',\n *   trackingKey: 'experiment_name',\n * };\n * ```\n */\ntype ExperimentFeatureFlag<\n  VT extends keyof ValueTypeMap,\n  Values extends ReadonlyArray<ValueTypeMap[VT]> = ReadonlyArray<ValueTypeMap[VT]>\n> = {\n  defaultValue: Values[number];\n  trackingKey?: string;\n  values: Values;\n  valueType: VT;\n};\n\n/**\n * Union type of all possible feature flag configurations.\n * Supports both core OFREP flags and experiment flags.\n */\ntype FeatureFlag =\n  | CoreFeatureFlag<'boolean'>\n  | CoreFeatureFlag<'number'>\n  | CoreFeatureFlag<'object'>\n  | CoreFeatureFlag<'string'>\n  | ExperimentFeatureFlag<'boolean'>\n  | ExperimentFeatureFlag<'number'>\n  | ExperimentFeatureFlag<'object'>\n  | ExperimentFeatureFlag<'string'>;\n\n/**\n * Helper to get the default value from a feature flag definition.\n * Works for both core flags (value) and experiment flags (defaultValue).\n */\ntype GetFlagDefault<F> = F extends { value: infer V } ? V : F extends { defaultValue: infer D } ? D : never;\n\n/**\n * All Logs Drilldown feature flags that we intend to use from the GoFF service are defined here.\n * {@link https://github.com/grafana/deployment_tools/blob/master/ksonnet/environments/hosted-grafana/waves/feature-toggles/goff/drilldown/logs/flag-definitions.libsonnet} for the source of truth.\n * Core feature flags are defined in the {@link https://github.com/grafana/grafana/blob/main/packages/grafana-data/src/types/featureToggles.gen.ts} file.\n */\nconst goffFeatureFlags = {\n  exploreLogsAggregatedMetrics: {\n    valueType: 'boolean',\n    value: false,\n    reason: 'static provider evaluation result',\n    variant: 'default',\n  },\n  'drilldown.logs.fake_flag': {\n    valueType: 'string',\n    values: [\n      'treatment',\n      'control', // default behavior\n      'excluded',\n    ],\n    defaultValue: 'excluded',\n    trackingKey: 'experiment_fake_flag',\n  },\n} as const satisfies Record<string, FeatureFlag>;\n\nconst featureFlagNames = getObjectKeys(goffFeatureFlags);\nexport type FeatureFlagName = (typeof featureFlagNames)[number];\nexport type FlagValue<T extends FeatureFlagName> = GetFlagDefault<(typeof goffFeatureFlags)[T]>;\nexport type FlagTrackingKey = (typeof goffFeatureFlags)[keyof typeof goffFeatureFlags] extends infer Flag\n  ? Flag extends { trackingKey: infer K }\n    ? K\n    : never\n  : never;\n\nexport const featureFlagTrackingKeys = Object.fromEntries(\n  featureFlagNames.reduce<Array<[FeatureFlagName, FlagTrackingKey]>>((acc, flagName) => {\n    const flagDef = goffFeatureFlags[flagName];\n    if ('trackingKey' in flagDef) {\n      acc.push([flagName, flagDef.trackingKey as FlagTrackingKey]);\n    }\n    return acc;\n  }, [])\n);\n\n/**\n * OpenFeature domain for the logs-drilldown plugin.\n * This isolates our provider from Grafana core and other plugins.\n */\nexport const OPEN_FEATURE_DOMAIN = 'logs-drilldown';\n\n/**\n * Cache for evaluated feature flag values.\n * Populated during app initialization via `initializeFeatureFlags()`.\n * Use `getFeatureFlag()` for synchronous access after initialization.\n */\nconst featureFlagCache = new Map<FeatureFlagName, FlagValue<FeatureFlagName>>();\n\n/**\n * Gets a feature flag value synchronously from the cache.\n * Returns the default value if the flag hasn't been evaluated yet.\n *\n * @param flagName - The name of the feature flag\n * @returns The cached flag value, or the default if not yet initialized\n */\nexport function getFeatureFlag<T extends FeatureFlagName>(flagName: T): FlagValue<T> {\n  if (featureFlagCache.has(flagName)) {\n    return featureFlagCache.get(flagName) as FlagValue<T>;\n  }\n  // Return default value if not yet initialized\n  const flagDef = goffFeatureFlags[flagName] as FeatureFlag;\n  if ('value' in flagDef) {\n    return flagDef.value as FlagValue<T>;\n  }\n  return flagDef.defaultValue as FlagValue<T>;\n}\n\n/**\n * Initializes all feature flags by evaluating them and caching the results.\n * Call this once during app initialization, after `initOpenFeatureProvider()`.\n */\nexport async function initializeFeatureFlags(): Promise<void> {\n  await Promise.all(\n    featureFlagNames.map(async (flagName) => {\n      const value = await evaluateFeatureFlag(flagName);\n      featureFlagCache.set(flagName, value);\n    })\n  );\n}\n\n/**\n * Initializes the OpenFeature provider for the logs-drilldown plugin.\n * This function should be called once during app initialization.\n *\n * @remarks\n * The provider is only initialized if it hasn't been set yet (checked by comparing to default provider).\n * This prevents re-initialization if the app component re-renders.\n */\nexport function initOpenFeatureProvider(): Promise<void> {\n  return OpenFeature.setProviderAndWait(\n    OPEN_FEATURE_DOMAIN,\n    new OFREPWebProvider({\n      baseUrl: `/apis/features.grafana.app/v0alpha1/namespaces/${config.namespace}`,\n      pollInterval: -1, // Do not poll - flags are fetched once on init\n      timeoutMs: 10_000, // Timeout after 10 seconds\n    }),\n    {\n      targetingKey: config.namespace, // Dimension of uniqueness, to ensure flags are evaluated consistently for a given stack\n      namespace: config.namespace, // Required by the multi-tenant feature flag service\n      ...config.openFeatureContext,\n    }\n  ).catch((error) => {\n    // OpenFeature initialization may fail in environments without the feature flag service (e.g., Grafana 11.6).\n    // This is expected and the app will continue to work with config.featureToggles fallback or default flag values.\n    logger.warn('OpenFeature provider initialization failed, using config.featureToggles fallback', {\n      error: error instanceof Error ? error.message : String(error),\n    });\n  });\n}\n\n/**\n * Helper to wait for a client to be ready.\n * Rejects if the provider is in an error state or fails to initialize.\n */\nfunction waitForClientReady(client: Client): Promise<void> {\n  if (client.providerStatus === ClientProviderStatus.READY) {\n    return Promise.resolve();\n  }\n  if (client.providerStatus === ClientProviderStatus.ERROR || client.providerStatus === ClientProviderStatus.FATAL) {\n    return Promise.reject(new Error('OpenFeature provider failed to initialize'));\n  }\n  return new Promise((resolve, reject) => {\n    client.addHandler(ProviderEvents.Ready, () => resolve());\n    client.addHandler(ProviderEvents.Error, () => reject(new Error('OpenFeature provider error')));\n  });\n}\n\n/**\n * Gets the default value from a feature flag definition.\n * Works for both core flags (value) and experiment flags (defaultValue).\n */\nfunction getFlagDefaultValue(flagDef: FeatureFlag): boolean | number | string | JsonValue {\n  if ('value' in flagDef) {\n    return flagDef.value;\n  }\n  return flagDef.defaultValue;\n}\n\n/**\n * Gets a fallback value from config.featureToggles for flags that have equivalents there.\n * This is used when the OpenFeature provider fails to initialize (e.g., in older Grafana versions like 11.6).\n *\n * @param flagName - The name of the feature flag\n * @returns The value from config.featureToggles if available, undefined otherwise\n */\nfunction getConfigToggleFallback(flagName: string): boolean | undefined {\n  // Only exploreLogsAggregatedMetrics has a config.featureToggles equivalent\n  if (flagName === 'exploreLogsAggregatedMetrics') {\n    return config.featureToggles.exploreLogsAggregatedMetrics;\n  }\n  return undefined;\n}\n\n/**\n * Evaluates a feature flag from the GoFF service.\n *\n * @param flagName - The name of the feature flag to evaluate.\n * @returns The value of the feature flag.\n */\nexport async function evaluateFeatureFlag<T extends keyof typeof goffFeatureFlags>(flagName: T): Promise<FlagValue<T>> {\n  try {\n    const client = OpenFeature.getClient(OPEN_FEATURE_DOMAIN);\n    await waitForClientReady(client);\n    client.addHooks(new TrackingHook());\n    const flagDef = goffFeatureFlags[flagName] as FeatureFlag;\n    // Check if the flag is a core flag or plugin-scoped flag\n    const defaultValue = getFlagDefaultValue(flagDef);\n\n    switch (flagDef.valueType) {\n      case 'boolean':\n        const booleanValue = client.getBooleanValue(flagName, defaultValue as boolean);\n        return booleanValue as FlagValue<T>;\n      case 'number':\n        const numberValue = client.getNumberValue(flagName, defaultValue as number);\n        return numberValue as FlagValue<T>;\n      case 'object':\n        const objectValue = client.getObjectValue(flagName, defaultValue as JsonValue);\n        return objectValue as FlagValue<T>;\n      case 'string':\n        const stringValue = client.getStringValue(flagName, defaultValue as string);\n        return stringValue as FlagValue<T>;\n      default:\n        throw new Error(`Invalid flag value type for flag ${flagName}`);\n    }\n  } catch (error) {\n    // On any error, try config.featureToggles fallback first, then default value\n    logger.error(new Error(`Error evaluating ${flagName} flag.`, { cause: error }));\n    const configValue = getConfigToggleFallback(flagName);\n    if (configValue !== undefined) {\n      return configValue as FlagValue<T>;\n    }\n    const flagDef = goffFeatureFlags[flagName] as FeatureFlag;\n    return getFlagDefaultValue(flagDef) as FlagValue<T>;\n  }\n}\n","/**\n * Helper function to cast `Object.keys` to the correct, narrowed type\n * @param obj - The object to get the keys from\n * @returns The keys of the object\n */\nexport function getObjectKeys<T extends object>(obj: T): Array<keyof T> {\n  return Object.keys(obj) as Array<keyof T>;\n}\n"],"names":["getStyles","theme","colorWeak","css","colors","text","secondary","icon","marginLeft","spacing","label","alignItems","display","marginBottom","marginTop","marginTopXl","note","color","updatePluginAndReload","pluginId","data","updatePlugin","locationService","reload","e","logger","error","msg","testIds","appConfig","container","datasource","interval","pattern","submit","response","getBackendSrv","fetch","method","url","lastValueFrom","isValid","seconds","rangeUtil","intervalToSeconds","isNumber","plugin","styles","useStyles2","enabled","jsonData","pinned","meta","state","setState","useState","dataSource","getLastUsedDataSourceFromStorage","getDefaultDatasourceFromDatasourceSrv","patternsDisabled","div","data-testid","FieldSet","Field","description","span","DataSourcePicker","width","filter","ds","type","current","onChange","uid","invalid","br","className","Input","id","value","placeholder","event","target","trim","a","href","rel","Checkbox","currentTarget","checked","Button","onClick","disabled","p","TRACKED_FLAG_VALUES","experiment_fake_flag","TrackingHook","after","hookContext","evaluationDetails","featureFlagTrackingKeys","flagKey","constructor","goffFeatureFlags","exploreLogsAggregatedMetrics","valueType","reason","variant","values","defaultValue","trackingKey","featureFlagNames","obj","Object","keys","fromEntries","reduce","acc","flagName","flagDef","push","OPEN_FEATURE_DOMAIN","featureFlagCache","Map","getFeatureFlag","has","get","initializeFeatureFlags","Promise","all","map","client","OpenFeature","getClient","providerStatus","ClientProviderStatus","READY","resolve","ERROR","FATAL","reject","Error","addHandler","ProviderEvents","Ready","waitForClientReady","addHooks","getFlagDefaultValue","getBooleanValue","getNumberValue","getObjectValue","getStringValue","cause","configValue","config","featureToggles","getConfigToggleFallback","undefined","evaluateFeatureFlag","set","initOpenFeatureProvider","setProviderAndWait","OFREPWebProvider","baseUrl","namespace","pollInterval","timeoutMs","targetingKey","openFeatureContext","catch","warn","message","String"],"sourceRoot":""}