{"version":3,"file":"913.js?_cache=7114f8bc77d7e100d586","mappings":"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","sources":["webpack://grafana-metricsdrilldown-app/./App/AppContext.tsx","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/behaviors/FilterGroupByAssertsLabelsBehavior.ts","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/behaviors/HistogramPercentilesDefaultBehavior.ts","webpack://grafana-metricsdrilldown-app/./exposedComponents/SourceMetrics/SourceMetrics.tsx","webpack://grafana-metricsdrilldown-app/./App/ErrorView.tsx","webpack://grafana-metricsdrilldown-app/./shared/utils/utils.timerange.ts","webpack://grafana-metricsdrilldown-app/./App/Routes.tsx"],"sourcesContent":["import { createContext, useContext } from 'react';\n\nimport { type DataTrail } from 'AppDataTrail/DataTrail';\nimport { newMetricsTrail } from 'shared/utils/utils';\n\ninterface AppContextState {\n  trail: DataTrail;\n}\n\nexport const defaultTrail = newMetricsTrail();\n\nexport const AppContext = createContext<AppContextState>({\n  trail: defaultTrail,\n});\n\nexport function useMetricsAppContext() {\n  return useContext(AppContext);\n}\n","import { SceneObjectBase, type SceneObjectState } from \"@grafana/scenes\";\n\nimport { GroupByOptionsLoadedEvent, type GroupByVariable } from \"MetricScene/Breakdown/GroupByVariable\";\n\n/**\n * Behavior that filters out \"asserts_*\" labels from the Breakdown view.\n * Subscribes at the root level to catch bubbled events from GroupByVariable when options are loaded.\n */\nexport class FilterGroupByAssertsLabelsBehavior extends SceneObjectBase<SceneObjectState> {\n  public constructor(params: { metric: string | undefined }) {\n    super({});\n\n    this.addActivationHandler(() => {\n      // Subscribe to the event at the root level to catch bubbled events\n      const subscription = this.getRoot().subscribeToEvent(GroupByOptionsLoadedEvent, (event) => {\n        if (params.metric?.startsWith('asserts')) {\n          // Avoid filtering asserts labels if selecting an asserts metric (not a source metric)\n          return;\n        }\n\n        this.filterVariableOptions(event.payload);\n      });\n      \n      return () => subscription.unsubscribe();\n    });\n  }\n\n  private filterVariableOptions(variable: GroupByVariable) {\n    const currentOptions = variable.state.options;\n\n    if (currentOptions.length === 0) {\n      return;\n    }\n\n    const filtered = currentOptions.filter((option) => !String(option.value).startsWith('asserts'));\n    \n    if (filtered.length !== currentOptions.length) {\n      variable.setState({ options: filtered });\n    }\n  }\n}\n","import { sceneGraph, SceneObjectBase, type SceneObjectState } from \"@grafana/scenes\";\n\nimport { GmdVizPanel } from \"shared/GmdVizPanel/GmdVizPanel\";\nimport { getMetricTypeSync } from \"shared/GmdVizPanel/matchers/getMetricType\";\nimport { PREF_KEYS } from \"shared/user-preferences/pref-keys\";\nimport { userStorage } from \"shared/user-preferences/userStorage\";\n\n/**\n * Behavior that sets histogram metrics to use percentiles as the default visualization.\n * This leverages the existing histogram preset configuration to apply percentiles by default\n * for histogram metrics in the SourceMetrics context only.\n */\nexport class HistogramPercentilesDefaultBehavior extends SceneObjectBase<SceneObjectState> {\n  private processedPanels = new WeakSet<GmdVizPanel>();\n\n  public constructor() {\n    super({});\n\n    this.addActivationHandler(() => {\n      const root = this.getRoot();\n      \n      const processPanels = () => {\n        const panels = sceneGraph.findAllObjects(root, (obj) => obj instanceof GmdVizPanel) as GmdVizPanel[];\n        \n        for (const panel of panels) {\n          // Skip if already processed\n          if (this.processedPanels.has(panel)) {\n            continue;\n          }\n          \n          const { metric, panelConfig } = panel.state;\n          const metricType = getMetricTypeSync(metric);\n          \n          // Check if user already has a preference for this metric\n          const userPrefs = userStorage.getItem(PREF_KEYS.METRIC_PREFS) || {};\n          const hasUserPreference = userPrefs[metric]?.config;\n          \n          // For histogram metrics without user preferences, apply percentiles preset\n          if ((metricType === 'classic-histogram' || metricType === 'native-histogram') && \n              !hasUserPreference &&\n              panelConfig.type === 'heatmap') {\n            // Use the histogram percentiles preset configuration\n            panel.update(\n              {\n                type: 'percentiles',\n              },\n              {\n                queries: [{ fn: 'histogram_quantile', params: { percentiles: [99, 90, 50] } }],\n              }\n            );\n          }\n          \n          this.processedPanels.add(panel);\n        }\n      };\n      \n      // Process existing panels immediately\n      processPanels();\n      \n      // Subscribe to root state changes to detect when new panels are added\n      // The WeakSet ensures we don't reprocess panels, making this efficient\n      const subscription = root.subscribeToState(processPanels);\n      \n      return () => subscription.unsubscribe();\n    });\n  }\n}\n","import { type AdHocVariableFilter, type DataSourceApi } from '@grafana/data';\nimport { locationService } from '@grafana/runtime';\nimport React, { useEffect, useRef } from 'react';\n\nimport { ErrorView } from 'App/ErrorView';\nimport { Trail } from 'App/Routes';\nimport { useCatchExceptions } from 'App/useCatchExceptions';\nimport { VAR_WINGMAN_SORT_BY } from 'MetricsReducer/list-controls/MetricsSorter/MetricsSorter';\nimport { metricFilters } from 'MetricsReducer/SideBar/SideBar';\nimport { logger } from 'shared/logger/logger';\nimport { reportExploreMetrics } from 'shared/tracking/interactions';\nimport { embeddedTrailNamespace, newMetricsTrail } from 'shared/utils/utils';\nimport { labelMatcherToAdHocFilter } from 'shared/utils/utils.variables';\n\nimport { FilterGroupByAssertsLabelsBehavior } from './behaviors/FilterGroupByAssertsLabelsBehavior';\nimport { HistogramPercentilesDefaultBehavior } from './behaviors/HistogramPercentilesDefaultBehavior';\nimport { parsePromQLQuery } from '../../extensions/links';\nimport { type PromQLLabelMatcher } from '../../shared/utils/utils.promql';\nimport { toSceneTimeRange } from '../../shared/utils/utils.timerange';\n\n/**\n * Extracts the prefix from a Prometheus metric name.\n * The prefix is the first part of the metric name before any separator (underscore or colon).\n * Example: \"grafana_slo_threshold_expression\" → \"grafana\"\n *          \"traces_spanmetrics_calls_total\" → \"traces\"\n */\nfunction extractMetricPrefix(metricName: string): string {\n  // Match up to the first non-alphanumeric character (typically underscore or colon)\n  const match = metricName.match(/^([a-zA-Z0-9]+)/);\n  return match ? match[1] : metricName;\n}\n\n/**\n * Extracts unique prefixes from an array of metric names.\n */\nfunction extractUniquePrefixes(metricNames: string[]): string[] {\n  const prefixes = new Set(metricNames.map(extractMetricPrefix));\n  return Array.from(prefixes);\n}\n\n/**\n * Captures the possible scenarios / data combinations for the Source Metrics experience.\n * This discriminated union gives us type safety for the different scenarios, and prevents us\n * from needing to use type assertions or null checks in the KnowledgeGraphSourceMetrics component.\n *\n * `fallbackQuery` typically contains an `asserts:*` recording rule metric and labels.\n */\ntype SourceMetricsScenario =\n  | {\n      scenario: 'recording_rule_fallback';\n      sourceMetrics: undefined;\n      fallbackQuery: ReturnType<typeof parsePromQLQuery>;\n    }\n  | {\n      scenario: 'single_source_metric';\n      sourceMetrics: SourceMetrics;\n      fallbackQuery: undefined;\n    }\n  | {\n      scenario: 'multiple_source_metrics';\n      sourceMetrics: SourceMetrics;\n      fallbackQuery: undefined;\n    }\n  | {\n      scenario: 'missing_metric_information';\n      sourceMetrics: undefined;\n      fallbackQuery: undefined;\n    };\n\nfunction getSourceMetricsScenario(props: Pick<SourceMetricsProps, 'query' | 'sourceMetrics'>): SourceMetricsScenario {\n  if (props.sourceMetrics && props.sourceMetrics.length > 0) {\n    return {\n      scenario: props.sourceMetrics.length === 1 ? 'single_source_metric' : 'multiple_source_metrics',\n      sourceMetrics: props.sourceMetrics,\n      fallbackQuery: undefined,\n    };\n  }\n\n  let fallbackQuery: ReturnType<typeof parsePromQLQuery> | undefined = undefined;\n\n  if (props.query) {\n    try {\n      fallbackQuery = parsePromQLQuery(props.query);\n    } catch (error) {\n      logger.error(new Error(`Failed to parse PromQL query: ${error}`), { query: props.query });\n    }\n  }\n\n  if (fallbackQuery) {\n    return {\n      scenario: 'recording_rule_fallback',\n      sourceMetrics: undefined,\n      fallbackQuery,\n    };\n  }\n\n  return { scenario: 'missing_metric_information', sourceMetrics: undefined, fallbackQuery: undefined };\n}\n\ntype SourceMetrics = Array<{\n  metricName: string;\n  labels: PromQLLabelMatcher[];\n}>;\n\nexport interface SourceMetricsProps {\n  query: string;\n  initialStart: string | number;\n  initialEnd: string | number;\n  dataSource: DataSourceApi;\n  sourceMetrics?: SourceMetrics;\n}\n\nconst KnowledgeGraphSourceMetrics = (props: SourceMetricsProps) => {\n  const [error] = useCatchExceptions();\n  const initRef = useRef(false);\n\n  useEffect(() => {\n    if (!initRef.current) {\n      initRef.current = true;\n      reportExploreMetrics('exposed_component_viewed', { component: 'knowledge_graph_source_metrics' });\n    }\n  }, []);\n\n  // Determine metric and filters based on data source\n  let metric: string | undefined;\n  let initialFilters: AdHocVariableFilter[] | undefined;\n\n  const { scenario, sourceMetrics, fallbackQuery } = getSourceMetricsScenario(props);\n  switch (scenario) {\n    case 'single_source_metric':\n      // If there's a single source metric, select it.\n      metric = sourceMetrics[0].metricName;\n      initialFilters = sourceMetrics[0].labels.map((label) => labelMatcherToAdHocFilter(label));\n      break;\n    case 'multiple_source_metrics':\n      // If there are multiple source metrics, we display\n      // the source metrics in the MetricsReducer, allowing\n      // users to select from the filtered list of metrics.\n      initialFilters = sourceMetrics[0].labels.map((label) => labelMatcherToAdHocFilter(label));\n\n      // Extract unique prefixes from sourceMetrics to filter the metrics list\n      // This naturally excludes metrics like \"asserts_*\" and \"ALERTS*\" that aren't in sourceMetrics\n      const prefixesToExclude = ['asserts', 'ALERTS'];\n      const sourceMetricPrefixes = extractUniquePrefixes(sourceMetrics.map((m) => m.metricName)).filter((metric) =>\n        prefixesToExclude.every((excludedPrefix) => !metric.startsWith(excludedPrefix))\n      );\n\n      // Set URL params for prefix filters BEFORE creating the trail\n      // This leverages Scenes' built-in URL sync in MetricsFilterSection\n      if (sourceMetricPrefixes?.length) {\n        const prefixUrlParam = `${embeddedTrailNamespace}-${metricFilters.prefix}`;\n        locationService.partial({ [prefixUrlParam]: sourceMetricPrefixes.join(',') }, true);\n\n        const sortByUrlParam = `${embeddedTrailNamespace}-var-${VAR_WINGMAN_SORT_BY}`;\n        locationService.partial({ [sortByUrlParam]: 'alphabetical' }, true);\n      }\n      break;\n    case 'recording_rule_fallback':\n      // When sourceMetrics aren't provided, fall back to\n      // selecting the metric from the provided PromQL query.\n      metric = fallbackQuery.metric;\n      initialFilters = fallbackQuery.labels.map((label) => labelMatcherToAdHocFilter(label));\n      break;\n    case 'missing_metric_information':\n      const err = new Error('Missing metric information for Knowledge Graph insight');\n      logger.error(err, { query: props.query });\n      return <ErrorView error={err} />;\n  }\n\n  // Create trail with behaviors:\n  // 1. Filter asserts labels from breakdown\n  // 2. Default histogram visualizations to percentiles (leveraging existing presets)\n  const trail = newMetricsTrail({\n    metric,\n    initialDS: props.dataSource.uid,\n    initialFilters,\n    $timeRange: toSceneTimeRange(props.initialStart, props.initialEnd),\n    embedded: true,\n    $behaviors: [new FilterGroupByAssertsLabelsBehavior({ metric }), new HistogramPercentilesDefaultBehavior()],\n  });\n\n  return (\n    <div data-testid=\"metrics-drilldown-embedded-label-breakdown\">\n      {error ? <ErrorView error={error} /> : <Trail trail={trail} />}\n    </div>\n  );\n};\n\nexport default KnowledgeGraphSourceMetrics;\n","import { css } from '@emotion/css';\nimport { type GrafanaTheme2 } from '@grafana/data';\nimport { t, Trans } from '@grafana/i18n';\nimport { Collapse, TextLink, useStyles2 } from '@grafana/ui';\nimport React, { useCallback, useState } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\n\nimport { InlineBanner } from './InlineBanner';\n\ntype ErrorViewProps = { error: Error };\n\nexport function ErrorView({ error }: Readonly<ErrorViewProps>) {\n  const styles = useStyles2(getStyles);\n\n  const navigate = useNavigate();\n  const { pathname, search } = useLocation();\n\n  const onClickReload = useCallback(() => {\n    const searchParams = new URLSearchParams(search);\n    const newSearchParams = new URLSearchParams();\n\n    // these are safe keys to keep\n    ['from', 'to', 'timezone']\n      .filter((key) => searchParams.has(key))\n      .forEach((key) => newSearchParams.set(key, searchParams.get(key)!));\n\n    navigate({ pathname, search: newSearchParams.toString() });\n    window.location.reload();\n  }, [navigate, pathname, search]);\n\n  const [isCollapseOpen, setIsCollapseOpen] = useState(false);\n\n  return (\n    <div className={styles.container}>\n      <InlineBanner\n        severity=\"error\"\n        title={t('error-view.title', 'Fatal error!')}\n        error={error}\n        errorContext={{ handheldBy: 'React error boundary' }}\n        message={\n          <>\n            <p className={styles.message}>\n              <Trans i18nKey=\"error-view.message\">\n                Please{' '}\n                <TextLink href=\"#\" onClick={onClickReload}>\n                  try reloading the page\n                </TextLink>{' '}\n                or, if the problem persists, contact your organization admin. Sorry for the inconvenience.\n              </Trans>\n            </p>\n            <p>\n              <Collapse\n                className={styles.callStack}\n                label={t('error-view.stack-trace-label', 'View stack trace')}\n                isOpen={isCollapseOpen}\n                onToggle={() => setIsCollapseOpen(!isCollapseOpen)}\n              >\n                <pre>\n                  <code>{error.stack}</code>\n                </pre>\n              </Collapse>\n            </p>\n          </>\n        }\n      />\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      margin: theme.spacing(2),\n    }),\n    message: css({\n      margin: theme.spacing(2, 0, 1, 0),\n    }),\n    callStack: css({\n      backgroundColor: 'transparent',\n      border: '0 none',\n\n      '& button': css({\n        paddingLeft: theme.spacing(1.5),\n      }),\n\n      '& button:focus': css({\n        outline: 'none',\n        boxShadow: 'none',\n      }),\n\n      '& button > svg': css({\n        marginLeft: theme.spacing(-2),\n        marginRight: theme.spacing(0.5),\n      }),\n\n      '& [class$=\"collapse__loader\"]': css({\n        display: 'none',\n      }),\n    }),\n  };\n}\n","import { dateMath } from '@grafana/data';\nimport { SceneTimeRange } from '@grafana/scenes';\n\ntype MathStringOrUnixTimestamp = string | number;\n\n/**\n * Convert a time string or unix timestamp to a SceneTimeRange.\n *\n * @param time - The time string or unix timestamp.\n * @returns The SceneTimeRange.\n *\n * @example\n * ```ts\n * toSceneTime('now-1h')\n * ```\n *\n * @example\n * ```ts\n * toSceneTime(1723756800000)\n * ```\n */\nfunction toSceneTime(time: MathStringOrUnixTimestamp): string {\n  if (typeof time === 'string' && dateMath.isMathString(time)) {\n    // 'now', 'now-1h', etc.\n    return time;\n  }\n\n  return dateMath.toDateTime(new Date(time), { roundUp: false })!.toISOString();\n}\n\n/**\n * Convert a time string or unix timestamp to a SceneTimeRange.\n *\n * @param from - The start time.\n * @param to - The end time.\n * @returns The SceneTimeRange.\n *\n * @example\n * ```ts\n * toSceneTimeRange('now-1h', 'now')\n * ```\n *\n * @example\n * ```ts\n * toSceneTimeRange(1723756800000, 1723756800000)\n * ```\n *\n * @example\n * ```ts\n * toSceneTimeRange('now-1h', 1723756800000)\n * ```\n */\nexport function toSceneTimeRange(from: MathStringOrUnixTimestamp, to: MathStringOrUnixTimestamp): SceneTimeRange {\n  return new SceneTimeRange({ from: toSceneTime(from), to: toSceneTime(to) });\n}\n","import React, { lazy } from 'react';\nimport { Navigate, Route, Routes, useLocation } from 'react-router-dom';\n\nimport { ROUTES } from 'shared/constants/routes';\n\nimport { useMetricsAppContext } from './AppContext';\n\nexport const Trail = lazy(() => import('./Trail'));\n\n// For /trail links, redirect to /drilldown with the same search params\nconst TrailRedirect = () => {\n  const location = useLocation();\n  return <Navigate to={`${ROUTES.Drilldown}${location.search}`} replace />;\n};\n\nexport const AppRoutes = () => {\n  const { trail } = useMetricsAppContext();\n\n  return (\n    <Routes>\n      <Route path={ROUTES.Drilldown} element={<Trail trail={trail} />} />\n      <Route path={ROUTES.Trail} element={<TrailRedirect />} />\n      {/* catch-all route */}\n      <Route path=\"*\" element={<Navigate to={ROUTES.Drilldown} replace />} />\n    </Routes>\n  );\n};\n"],"names":["defaultTrail","newMetricsTrail","AppContext","createContext","trail","useMetricsAppContext","useContext","FilterGroupByAssertsLabelsBehavior","SceneObjectBase","filterVariableOptions","variable","currentOptions","state","options","length","filtered","filter","option","String","value","startsWith","setState","params","super","this","addActivationHandler","subscription","getRoot","subscribeToEvent","GroupByOptionsLoadedEvent","event","metric","payload","unsubscribe","HistogramPercentilesDefaultBehavior","processedPanels","WeakSet","root","processPanels","panels","sceneGraph","findAllObjects","obj","GmdVizPanel","panel","userPrefs","has","panelConfig","metricType","getMetricTypeSync","hasUserPreference","userStorage","getItem","PREF_KEYS","METRIC_PREFS","config","type","update","queries","fn","percentiles","add","subscribeToState","extractMetricPrefix","metricName","match","props","error","useCatchExceptions","initRef","useRef","initialFilters","useEffect","current","reportExploreMetrics","component","scenario","sourceMetrics","fallbackQuery","undefined","query","parsePromQLQuery","logger","Error","getSourceMetricsScenario","labels","map","label","labelMatcherToAdHocFilter","prefixesToExclude","sourceMetricPrefixes","metricNames","prefixes","Set","Array","from","extractUniquePrefixes","m","every","excludedPrefix","prefixUrlParam","embeddedTrailNamespace","metricFilters","prefix","locationService","partial","join","sortByUrlParam","VAR_WINGMAN_SORT_BY","err","ErrorView","initialDS","dataSource","uid","$timeRange","toSceneTimeRange","initialStart","initialEnd","embedded","$behaviors","div","data-testid","Trail","styles","useStyles2","getStyles","navigate","useNavigate","pathname","search","useLocation","onClickReload","useCallback","searchParams","URLSearchParams","newSearchParams","key","forEach","set","get","toString","window","location","reload","isCollapseOpen","setIsCollapseOpen","useState","className","container","InlineBanner","severity","title","t","errorContext","handheldBy","message","p","Trans","i18nKey","TextLink","href","onClick","Collapse","callStack","isOpen","onToggle","pre","code","stack","theme","css","margin","spacing","backgroundColor","border","paddingLeft","outline","boxShadow","marginLeft","marginRight","display","toSceneTime","time","dateMath","isMathString","toDateTime","Date","roundUp","toISOString","to","SceneTimeRange","lazy","TrailRedirect","Navigate","ROUTES","Drilldown","replace","AppRoutes","Routes","Route","path","element"],"sourceRoot":""}